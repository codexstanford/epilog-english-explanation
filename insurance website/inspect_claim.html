
<html>

    <!--=======================================================================-->
    
    <head>
      <title>Insurance</title>
      <script language='javascript' src='./src/epilog.js'></script>
      <script language='javascript' src='./src/worksheets.js'></script>
      <script language='javascript' src='./src/localstorage.js'></script>
    </head>
    
    <!--=======================================================================-->
    
    <body align='center' bgcolor='#f8f8f8' onLoad='initialize()'>
      <center>
        <table width='640' cellspacing='0' cellpadding='0'>
          <tr>
            <td>
    
    <!--=======================================================================-->
    
    <center>
      <table width='640' cellpadding='0' cellspacing='0' border='0'>
        <tr>
          <td width='640' height='90' align='center'>
            <a href='./index.html' style='font-size:48px;color:#000088;text-decoration:none'>Insurance</a>
          </td>
        </tr>
      </table>
    </center>
    
    <!--=======================================================================-->
    
    <center>
      <br/>
      <table style='border:1px solid #888888;border-collapse:collapse' cellpadding='5' bgcolor='#ffffff'>
        <tr>
          <td colspan='2' align="center" style='border:1px solid #888888;background-color:#dddddd'>Claim</td>
        </tr>
        <tr>
          <td style='font-weight:bold' style='border:1px solid #888888;background-color:#dddddd'>Id</td>
          <td id='id' valign='top'></td>
        </tr>
        <tr>
          <td style='font-weight:bold' style='border:1px solid #888888;background-color:#dddddd'>Policy</td>
          <td id='policy' valign='top'></td>
        </tr>
        <tr>
          <td style='font-weight:bold' style='border:1px solid #888888;background-color:#dddddd'>Hospitalization</td>
          <td id='hospitalization' valign='top'></td>
        </tr>
        <tr>
          <td style='font-weight:bold' style='border:1px solid #888888;background-color:#dddddd'>Prior Hospitalization</td>
          <td id='priorhospitalization' valign='top'></td>
        </tr>
        <tr>
          <td style='font-weight:bold' style='border:1px solid #888888;background-color:#dddddd'>Disposition</td>
          <td id='disposition' valign='top'></td>
        </tr>
        <tr>
          <td style='font-weight:bold' style='border:1px solid #888888;background-color:#dddddd'>Recommendation</td>
          <td id='recommendation' valign='top'></td>
        </tr>
        <tr>
          <td style='font-weight:bold' style='border:1px solid #888888;background-color:#dddddd'>Justification</td>
          <td id='justification' valign='top'></td>
        </tr>
        <tfoot>
          <tr>
            <td colspan='2' align="center" style='border:1px solid #888888;background-color:#dddddd'>
              <input type='button' id='changer' value='Change' onclick='modreplace(this)'/>
              <input type='button' id='viewer' value='User View' onclick='modreplace(this)'/>
            </td>
          </tr>
        </tfoot>
      </table>
    </center>
    
    <!--=======================================================================-->
    
    <textarea id='library' type='text/hrf' style='display:none'>
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %%% recommendations
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    
    claim.recommendation(C,pay) :-
      plan_in_effect(C) &
      ~partial_day(C) &
      evaluate(countofall(E,exclusion(C,E)),0)
    
    claim.recommendation(C,decline) :- partial_day(C)
    claim.recommendation(C,decline) :- exclusion(C,E)
    
    plan_in_effect(C) :-
      claim.policy(C,P) &
      claim.hospitalization(C,Z) &
      policy.startdate(P,PS) &
      policy.enddate(P,PE) &
      hospitalization.startdate(Z,ZS) &
      hospitalization.enddate(Z,ZE) &
      overlap(PS,PE,ZS,ZE)
    
    partial_day(C) :-
      claim.hospitalization(C,Z) &
      duration(Z,DURATION) &
      less(DURATION,86400000)
    
    duration(Z,DURATION) :-
      hospitalization.startdate(Z,SD) &
      hospitalization.starttime(Z,ST) &
      hospitalization.enddate(Z,ED) &
      hospitalization.endtime(Z,ET) &
      datetimetotimestamp(SD,ST,SS) &
      datetimetotimestamp(ED,ET,ES) &
      evaluate(minus(ES,SS),DURATION)
    
    exclusion(C,4.3m) :-
      claim.hospitalization(C,Z) &
      hospitalization.patient(Z,P) &
      hospitalization.patient(Y,P) &
      distinct(Y,Z) &
      hospitalization.diagnosis(Z,D) &
      hospitalization.diagnosis(Y,D) &
      hospitalization.startdate(Z,ZS) &
      hospitalization.enddate(Y,YE) &
      evaluate(stringmin(YE,ZS),YE)
    
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %%% general definitions and predefined relations
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    
    overlap(PS,PE,ZS,ZE) :-
      evaluate(stringmin(ZS,PE),ZS) &
      evaluate(stringmin(PS,ZE),PS)
    
    datetimetotimestamp(DATE,TIME,STAMP) :-
      evaluate(parsedate(DATE),[Y,M,D]) &
      evaluate(parsetime(TIME),[H,N,S]) &
      evaluate(maketimestamp(Y,M,D,H,N,S),STAMP)
    
    parsedate(DATE) :=
      map(readstring,tail(matches(stringify(DATE),"(....)_(..)_(..)")))
    
    parsetime(TIME) :=
      map(readstring,tail(matches(stringify(TIME),"(..)_(..)_(..)")))
    
    leq(X,Y) :- evaluate(min(X,Y),X)
    less(X,Y) :- evaluate(min(X,Y),X) & distinct(X,Y)
    
    head(X!L) := X
    tail(X!L) := L
    
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %%% Worksheet Rules
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    
    load ::
      evaluate(parameter(room),R) &
      evaluate(parameter(id),C) &
      stringappend("change_claim.html?room=",R,"&id=",C,IS)
      ==> setattribute(changer,href,IS)
    
    load ::
      evaluate(parameter(room),R) &
      evaluate(parameter(id),C) &
      stringappend("claim.html?room=",R,"&id=",C,IS)
      ==> setattribute(viewer,href,IS)
    
    innerhtml(id,P) :- evaluate(parameter(id),P)
    
    innerhtml(policy,Link) :-
      evaluate(parameter(id),X) &
      claim.policy(X,P) &
      link(inspect,policy,P,Link)
    
    innerhtml(hospitalization,Link) :-
      evaluate(parameter(id),X) &
      claim.hospitalization(X,H) &
      link(inspect,hospitalization,H,Link)
    
    innerhtml(priorhospitalization,Link) :-
      evaluate(parameter(id),P) &
      claim.priorhospitalization(P,H) &
      link(inspect,hospitalization,H,Link)
    
    innerhtml(disposition,D) :-
      evaluate(parameter(id),P) &
      claim.disposition(P,D)
    
    innerhtml(recommendation,R) :-
      evaluate(parameter(id),C) &
      claim.recommendation(C,R)
    
    innerhtml(justification,LINK) :-
      evaluate(parameter(id),C) &
      claim.recommendation(C,R) &
      evaluate(stringify(delistify([claim.recommendation,C,R])),CS) &
      stringappend("<a href='justify.html?room=codex&conclusion=",CS,"' style='color:#0044bb;text-decoration:none;cursor:pointer' target='explanation'>Explain</a>",LINK)
    
    link(Sheet,Class,Object,Link) :-
      stringify(Sheet,SS) & stringify(Class,CS) & stringify(Object,OS) &
      stringappend("<a href='",SS,"_",CS,".html?room=codex&id=",OS,"' style='color:#0044bb;text-decoration:none;cursor:pointer'>",OS,"</a>",Link)
    
    </textarea>
    
    <!--=======================================================================-->
    
    <textarea id='lambda' style='display:none'>
    </textarea>
    
    <!--=======================================================================-->
    
            </td>
          </tr>
        </table>
      </center>
    </body>
    
    <!--=======================================================================-->
    
    </html>
    